<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= title %></title>
  <style>
    .navbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;padding:8px 0;}
    .navbar form{margin:0;}

    /* QBT status indicators */
    .qbt-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1;
      white-space: nowrap;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      border: 1px solid rgba(0,0,0,.2);
    }
    .dot--green  { background: #2ecc71; }
    .dot--yellow { background: #f1c40f; }
    .dot--red    { background: #e74c3c; }
    .qbt-msg { opacity: .85; font-size: 12px; }

    /* Uniform-height "buttons" for both links and real buttons */
    .navbtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:44px;
      padding:0 12px;
      border:1px solid #999;
      background:#f6f6f6;
      border-radius:6px;
      text-decoration:none;
      color:#000;
      font:inherit;
      line-height:1.1;
      cursor:pointer;
      box-sizing:border-box;
      user-select:none;
    }
    a.navbtn:hover, button.navbtn:hover{background:#ececec;}
    button.navbtn{appearance:none;-webkit-appearance:none;}

    .navbtn--wide{padding:0 14px;}
    .navbtn small{font-size:0.8em;opacity:0.8;}

    .notice{padding:8px 10px;border:1px solid #f3c15a;background:#fff7e0;border-radius:6px;}
    .nav-notice{padding:6px 10px;border:1px solid #c9d7ff;background:#eef3ff;border-radius:6px;}
  </style>
</head>
<body>  <div class="navbar">
    % my $qh = app->defaults->{health}{qbt} || {};

    % my $proc_up   = $qh->{qbt_up} ? 1 : 0;
    % my $api_known = $qh->{want_api} ? 1 : 0;  # only true if we actually probed
    % my $api_ok    = $qh->{api_ok} ? 1 : 0;
    % my $err       = $qh->{echo_err} // '';

    % my ($dot_class, $dot_label, $msg);

    % if ( !$proc_up ) {
    %   $dot_class = 'dot--red';
    %   $dot_label = 'qbt down';
    %   $msg = length($err) ? $err : 'not running';
    % } elsif ( $api_known && !$api_ok ) {
    %   $dot_class = 'dot--yellow';
    %   $dot_label = 'qbt degraded';
    %   $msg = length($err) ? $err : 'qbt not responding';
    % } else {
    %   $dot_class = 'dot--green';
    %   $dot_label = $api_known ? 'qbt ok' : 'qbt up';
    %   $msg = '';
    % }

    <div class="qbt-indicator" title="<%= $msg %>">
      <span class="dot <%= $dot_class %>"></span>
      <span><%= $dot_label %></span>
      % if (length $msg) {
        <span class="qbt-msg"><%= $msg %></span>
      % }
    </div>

    <a class="navbtn" href="/">Home</a>
    <a class="navbtn" href="/qbt/hashnames">QBT hash-names</a>
    <a class="navbtn" href="/qbt/repairable">Repairable</a>
    <a class="navbtn" href="/qbt/triage">Triage</a>
    <a class="navbtn" href="/torrents">Page View</a>
    <a class="navbtn" href="/qbt/add_one">Single View</a>
    <a class="navbtn" href="/qbt/no_payload">No Payload</a>

    % # Localcache rebuild status (canonical: defaults->{localcache_rebuild}{inflight})
    % my $lc = app->defaults->{localcache_rebuild} || {};
    % if (ref($lc) eq 'HASH' && $lc->{inflight}) {
      % my $dt = ($lc->{started_ts} && $lc->{started_ts} =~ /^\d+$/) ? (time - $lc->{started_ts}) : '';
      <div class="nav-notice">Rebuilding local cache‚Ä¶<%= length($dt) ? " (${dt}s)" : "" %></div>
    % }

    % if (stash('dev_mode')) {
      % my $notice = stash('notice') // flash('notice');
      % if ($notice) {
        <div class="notice"><%= $notice %></div>
      % }

      % my $ts        = stash('local_cache_mtime') // app->defaults->{local_cache_mtime} // 0;
      % my $nav_label = $ts ? scalar(localtime($ts)) : 'never';

      % # token: prefer stash, fall back to session (layout used by many pages)
      % my $tok = stash('rebuild_tok');
      % $tok = session('rebuild_tok') unless defined($tok) && length($tok);

      <form method="post" action="/localcache/rebuild">
        <input type="hidden" name="tok" value="<%= $tok // '' %>">
        <button class="navbtn navbtn--wide" type="submit">Rebuild Cache<br>
          <small>Last: <%= $nav_label %></small>
        </button>
      </form>

      %# -----------------------------
      %# Dev prefs: HTTP UA dump toggle
      %# -----------------------------
      % my $http_debug = app->defaults->{http_debug} ? 1 : 0;

      % my $return_to = $c->req->url->path->to_string // '/';
      % my $qs = $c->req->url->query->to_string // '';
      % $return_to .= "?$qs" if length $qs;
      % $return_to = '/' if $return_to !~ m{\A/} || $return_to =~ m{://} || $return_to =~ m{[\r\n]};

      <form method="post" action="/dev/prefs/http_debug" style="display:inline-flex; align-items:center; gap:8px;">
        <input type="hidden" name="return_to" value="<%= $return_to %>">

        <span style="opacity:0.75;">HTTP dump:</span>

        <label style="display:inline-flex; align-items:center; gap:6px;">
          <input type="radio" name="http_debug" value="0"
                 <%= $http_debug ? '' : 'checked' %>
                 onchange="this.form.submit()">
          Off
        </label>

        <label style="display:inline-flex; align-items:center; gap:6px;">
          <input type="radio" name="http_debug" value="1"
                 <%= $http_debug ? 'checked' : '' %>
                 onchange="this.form.submit()">
          On
        </label>
      </form>

      <form method="post" action="/restart">
        <button class="navbtn" type="submit">Restart server (dev)</button>
      </form>
    % }
  </div>

  <hr />
  <div id="qbtlModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999;">
  <div style="max-width:900px; margin:6vh auto; background:#111; border:1px solid #333; border-radius:10px;
padding:14px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div>
        <div id="qbtlModalTitle" style="font-size:1.1em; font-weight:600;"></div>
        <div id="qbtlModalSub" style="opacity:.75; font-size:.9em;"></div>
      </div>
      <button type="button" id="qbtlModalClose">Done</button>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
      <button type="button" id="qbtlModalAdd">Add</button>
      <div style="opacity:.7; font-size:.9em;">(Uses cached meta only ‚Äî no filesystem)</div>
    </div>

    <div style="margin-top:12px; max-height:60vh; overflow:auto; border-top:1px solid #222; padding-top:10px;">
      <div id="qbtlTree"></div>
    </div>

    <!-- hidden "Add" form submitted by the modal -->
    <form id="qbtlModalAddForm" method="post" action="/qbt/add_one" style="display:none;">
      <input type="hidden" name="ih" value="">
      <input type="hidden" name="hash" value="">
      <input type="hidden" name="source_path" value="">
      <input type="hidden" name="confirm" value="1">
      <input type="hidden" name="return_to" value="">
    </form>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('qbtlModal');
  const title = document.getElementById('qbtlModalTitle');
  const sub   = document.getElementById('qbtlModalSub');
  const tree  = document.getElementById('qbtlTree');
  const btnClose = document.getElementById('qbtlModalClose');
  const btnAdd   = document.getElementById('qbtlModalAdd');
  const addForm  = document.getElementById('qbtlModalAddForm');

  function esc(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  function buildTree(paths, rootName){
    // root -> nested objects
    const root = {};
    for (const p of paths) {
      if (!p) continue;
      const parts = p.split('/').filter(Boolean);

      // If paths include the torrent name as first segment, drop it
      if (rootName && parts[0] === rootName) parts.shift();
      if (!parts.length) continue;

      let cur = root;
      for (let i=0;i<parts.length;i++){
        const k = parts[i];
        cur[k] = cur[k] || {};
        cur = cur[k];
      }
    }
    return root;
  }

  function renderNode(obj, indent){
    const keys = Object.keys(obj).sort((a,b)=>a.localeCompare(b));
    let html = '<ul style="list-style:none; padding-left:'+(indent?18:0)+'px; margin:0;">';
    for (const k of keys){
      const child = obj[k];
      const isDir = child && Object.keys(child).length > 0;
      if (isDir){
        html += `
          <li style="margin:2px 0;">
            <details open>
              <summary style="cursor:pointer;">üìÅ ${esc(k)}</summary>
              ${renderNode(child, true)}
            </details>
          </li>`;
      } else {
        html += `<li style="margin:2px 0; padding-left:18px;">üìÑ ${esc(k)}</li>`;
      }
    }
    html += '</ul>';
    return html;
  }

  function openModal({ih, source_path}){
    title.textContent = 'Loading‚Ä¶';
    sub.textContent = ih;
    tree.innerHTML = '';

    modal.style.display = 'block';
    addForm.elements.namedItem('ih').value = ih;
    addForm.elements.namedItem('hash').value = ih;
    addForm.elements.namedItem('source_path').value = source_path || '';
    addForm.elements.namedItem('return_to').value = window.location.pathname + window.location.search;

    fetch('/api/torrent_tree/' + encodeURIComponent(ih))
      .then(r => r.json())
      .then(j => {
        if (!j || !j.ok) throw new Error((j && j.err) || 'fetch failed');
        const nm = j.name || '';
        const files = (j.files || []).map(x => x.path || '');
        title.textContent = nm ? nm : '(no name)';
        sub.textContent = ih + (files.length ? ('  ‚Ä¢  ' + files.length + ' files') : '');
        const t = buildTree(files, nm);
        tree.innerHTML = renderNode(t, false);
      })
      .catch(e => {
        title.textContent = 'Error';
        tree.innerHTML = '<div style="color:#f66;">' + esc(e.message) + '</div>';
      });
  }

  function closeModal(){
    modal.style.display = 'none';
  }

  document.addEventListener('click', function(ev){
    const btn = ev.target.closest('.qbtl-view');
    if (!btn) return;
    openModal({
      ih: btn.getAttribute('data-ih') || '',
      source_path: btn.getAttribute('data-source_path') || ''
    });
  });

  btnClose.addEventListener('click', closeModal);
  modal.addEventListener('click', function(ev){
    if (ev.target === modal) closeModal(); // click backdrop closes
  });

  btnAdd.addEventListener('click', function(){
    addForm.submit();
  });
})();
</script>

  <%= content %>
</body>
</html>
