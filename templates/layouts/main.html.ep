<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= title %></title>
  <style>
    .navbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;padding:8px 0;}
    .navbar form{margin:0;}

    /* QBT status indicators */
    .qbt-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1;
      white-space: nowrap;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      border: 1px solid rgba(0,0,0,.2);
    }
    .dot--green  { background: #2ecc71; }
    .dot--yellow { background: #f1c40f; }
    .dot--red    { background: #e74c3c; }
    .qbt-msg { opacity: .85; font-size: 12px; }

    /* Uniform-height "buttons" for both links and real buttons */
    .navbtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:44px;
      padding:0 12px;
      border:1px solid #999;
      background:#f6f6f6;
      border-radius:6px;
      text-decoration:none;
      color:#000;
      font:inherit;
      line-height:1.1;
      cursor:pointer;
      box-sizing:border-box;
      user-select:none;
    }
    a.navbtn:hover, button.navbtn:hover{background:#ececec;}
    button.navbtn{appearance:none;-webkit-appearance:none;}

    .navbtn--wide{padding:0 14px;}
    .navbtn small{font-size:0.8em;opacity:0.8;}

    .notice{padding:8px 10px;border:1px solid #f3c15a;background:#fff7e0;border-radius:6px;}
    .nav-notice{padding:6px 10px;border:1px solid #c9d7ff;background:#eef3ff;border-radius:6px;}
  </style>
</head>
<body>
  <div class="navbar">
    % my $qh = app->defaults->{health}{qbt} || {};

    % my $proc_up   = $qh->{qbt_up} ? 1 : 0;
    % my $api_known = $qh->{want_api} ? 1 : 0;  # only true if we actually probed
    % my $api_ok    = $qh->{api_ok} ? 1 : 0;
    % my $err       = $qh->{echo_err} // '';

    % my ($dot_class, $dot_label, $msg);

    % if ( !$proc_up ) {
    %   $dot_class = 'dot--red';
    %   $dot_label = 'qbt down';
    %   $msg = length($err) ? $err : 'not running';
    % } elsif ( $api_known && !$api_ok ) {
    %   $dot_class = 'dot--yellow';
    %   $dot_label = 'qbt degraded';
    %   $msg = length($err) ? $err : 'qbt not responding';
    % } else {
    %   $dot_class = 'dot--green';
    %   $dot_label = $api_known ? 'qbt ok' : 'qbt up';
    %   $msg = '';
    % }

    <div class="qbt-indicator" title="<%= $msg %>">
      <span class="dot <%= $dot_class %>"></span>
      <span><%= $dot_label %></span>
      % if (length $msg) {
        <span class="qbt-msg"><%= $msg %></span>
      % }
    </div>

    <a class="navbtn" href="/">Home</a>
    <a class="navbtn" href="/qbt/hashnames">QBT hash-names</a>
    <a class="navbtn" href="/qbt/repairable">Repairable</a>
    <a class="navbtn" href="/qbt/triage">Triage</a>
    <a class="navbtn" href="/torrents">Page View</a>
    <a class="navbtn" href="/qbt/add_one">Single View</a>
    <a class="navbtn" href="/qbt/no_payload">No Payload</a>

    % # Localcache rebuild status (canonical: defaults->{localcache_rebuild}{inflight})
    % my $lc = app->defaults->{localcache_rebuild} || {};
    % if (ref($lc) eq 'HASH' && $lc->{inflight}) {
      % my $dt = ($lc->{started_ts} && $lc->{started_ts} =~ /^\d+$/) ? (time - $lc->{started_ts}) : '';
      <div class="nav-notice">Rebuilding local cacheâ€¦<%= length($dt) ? " (${dt}s)" : "" %></div>
    % }

    % if (stash('dev_mode')) {
      % my $notice = stash('notice') // flash('notice');
      % if ($notice) {
        <div class="notice"><%= $notice %></div>
      % }

      % my $ts        = stash('local_cache_mtime') // app->defaults->{local_cache_mtime} // 0;
      % my $nav_label = $ts ? scalar(localtime($ts)) : 'never';

      % # token: prefer stash, fall back to session (layout used by many pages)
      % my $tok = stash('rebuild_tok');
      % $tok = session('rebuild_tok') unless defined($tok) && length($tok);

      <form method="post" action="/localcache/rebuild">
        <input type="hidden" name="tok" value="<%= $tok // '' %>">
        <button class="navbtn navbtn--wide" type="submit">Rebuild Cache<br>
          <small>Last: <%= $nav_label %></small>
        </button>
      </form>

      <form method="post" action="/restart">
        <button class="navbtn" type="submit">Restart server (dev)</button>
      </form>
    % }
  </div>

  <hr />

  <%= content %>
</body>
</html>
